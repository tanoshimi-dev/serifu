FROM golang:1.21-alpine

WORKDIR /app

# Install dependencies (gcc/musl-dev needed for SQLite CGO, git for modules)
RUN apk add --no-cache gcc musl-dev git

# Install templ CLI
RUN go install github.com/a-h/templ/cmd/templ@v0.2.778

# Copy source code
COPY . .

# Generate templ templates
RUN templ generate

# Download dependencies
RUN go mod tidy

# Run tests with CGO enabled (required for SQLite)
CMD ["sh", "-c", "CGO_ENABLED=1 go test ./... -v"]
